<?xml version="1.0" encoding="UTF-8"?>
<modification>
  <id>Multi Shop Product Filter</id>
  <version>2.0</version>
  <vqmver>2.2.1</vqmver>
  <author>Jason Clark (mithereal@gmail.com)</author>
  
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  public function index() {
		  ]]></search>
      <add><![CDATA[
		  $this->load->language('module/store_filter');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  protected function getList() {
		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['filter_store'])) {
			$filter_store = $this->request->get['filter_store'];
		} else {
			$filter_store = null;
		}
		  ]]></add>
    </operation>
  
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  'filter_status'   => $filter_status,
		  ]]></search>
      <add><![CDATA[
		  'filter_store'   => $filter_store,
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  'price'      => $result['price'],
		  ]]></search>
      <add><![CDATA[
		  'store'      => $result['store_id'],
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
if (is_file(DIR_IMAGE . $result['image'])) {
		  ]]></search>
      <add><![CDATA[
		  if(!isset($result['store_id'])){
          $result['store_id'] = "Default";
                    }
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $data['column_status'] = $this->language->get('column_status');
		  ]]></search>
      <add><![CDATA[
		  $data['column_store'] = $this->language->get('column_store');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if ($order == 'ASC') {
		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['filter_store'])) {
			$url .= '&filter_store=' . $this->request->get['filter_store'];
		}
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
				$results = $this->model_catalog_product->getProducts($filter_data);

		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['store'])) {
			$url .= '&store=' . $this->request->get['store'];
		}
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $data['sort_order'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.sort_order' . $url, 'SSL');
		  ]]></search>
      <add><![CDATA[
		  $data['sort_store'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.sort_store' . $url, 'SSL');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $data['filter_status'] = $filter_status;
		  ]]></search>
      <add><![CDATA[
		  $data['filter_store'] = $filter_store;
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $data['entry_status'] = $this->language->get('entry_status');
		  ]]></search>
      <add><![CDATA[
		 $data['entry_store'] = $this->language->get('entry_store');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if (isset($this->request->post['keyword'])) {
		  ]]></search>
      <add><![CDATA[
		 $this->load->model('setting/store');
		 $data['stores'] = $this->model_setting_store->getStores();

		 if (isset($this->request->post['product_store'])) {
			$this->data['product_store'] = $this->request->post['product_store'];
		} elseif (isset($this->request->get['product_id'])) {
			$this->data['product_store'] = $this->model_catalog_product->getProductStores($this->request->get['product_id']);
		} else {
			$this->data['product_store'] = array(0);
		}	
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[ 
            $this->response->setOutput($this->load->view('catalog/product_list.tpl', $data));
		  ]]></search>
      <add><![CDATA[
		 $this->load->model('setting/store');
		 $data['stores'] = $this->model_setting_store->getStores();

		  ]]></add>
    </operation>
  </file>

  <file name="admin/model/catalog/product.php">
<operation>
<search position="after"><![CDATA[
$sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
]]></search>
<add><![CDATA[
$sql .= " LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)";
]]></add>
</operation>
</file>

<file name="admin/model/catalog/product.php">
<operation>
<search position="replace"><![CDATA[
$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
]]></search>
<add><![CDATA[
$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)  LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id) WHERE pd.language_id = '" . (int)$this->config->get('config_language_id') . "'";
        var_dump($sql);
]]></add>
</operation>
</file>

 <file name="admin/model/catalog/product.php">
<operation>
<search position="before"><![CDATA[
if (isset($data['filter_status']) && $data['filter_status'] !== null) {
]]></search>
<add><![CDATA[
if (isset($data['filter_store'])) {
$sql .= " AND p2s.store_id = '".$data['filter_store']."'";
}
]]></add>
</operation>
</file>

  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="before"><![CDATA[
		   <td class="text-right"><?php echo $column_action; ?></td>
		  ]]></search>
      <add><![CDATA[
		 <td class="text-left"><?php if ($sort == 'p.store') { ?>
                <a href="<?php echo $sort_store; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_store; ?></a>
                <?php } else { ?>
                <a href="<?php echo $sort_store; ?>"><?php echo $column_store; ?></a>
                <?php } ?></td>
		  ]]></add>
    </operation>
  </file>
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="before"><![CDATA[
		               <button type="button" id="button-filter" class="btn btn-primary pull-right"><i class="fa fa-search"></i> <?php echo $button_filter; ?></button>

		  ]]></search>
      <add><![CDATA[</div>
		    <div class="col-sm-4">
              <div class="form-group">
                <label class="control-label" for="input-store"><?php echo $entry_store; ?></label>
                <select name="filter_store" id="input-store" class="form-control">
              <option value="*">Default</option>
                  <?php 
					  foreach ($stores as $store) {
						  if ($filter_store && $filter_store == $store['store_id']) { 
						  ?>
						  <option value="<?php echo $store['store_id']; ?>" selected="selected"><?php echo $store['name']; ?></option>
					<?php
					  }else{
					  ?>
					  <option value="<?php echo $store['store_id']; ?>"><?php echo $store['name']; ?></option>
                  <?php }
						} ?>
                </select>
              </div>
              </div>
		  ]]></add>
    </operation>
  </file>
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="after"><![CDATA[
                  <td class="text-left"><?php echo $product['status']; ?></td>

		  ]]></search>
      <add><![CDATA[
		<td class="text-left"><?php echo $product['store']; ?></td>
		  ]]></add>
    </operation>
  </file>
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="before"><![CDATA[
                  var filter_status = $('select[name=\'filter_status\']').val();

		  ]]></search>
      <add><![CDATA[
		var filter_store = $('select[name=\'filter_store\']').val();

	if(filter_store != '*') {
		url += '&filter_store=' + encodeURIComponent(filter_store);
	}
		  ]]></add>
    </operation>
  </file>


</modification>
