<?xml version="1.0" encoding="UTF-8"?>
<modification>
  <id>Multi Shop Product Filter</id>
  <version>1.0</version>
  <vqmver>2.2.1</vqmver>
  <author>Jason Clark (mithereal@gmail.com)</author>
  
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  public function index() {
		  ]]></search>
      <add><![CDATA[
		  $this->language->load('module/store_filter');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if (isset($this->request->get['sort'])) {
		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['filter_store'])) {
			$filter_store = $this->request->get['filter_store'];
			if(isset($url)){
			$url .= '&filter_store=' . $this->request->get['filter_store'];
			}
		} else {
			$filter_store = null;
		}
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  'filter_status'   => $filter_status,
		  ]]></search>
      <add><![CDATA[
		  'filter_store'   => $filter_store,
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  'price'      => $result['price'],
		  ]]></search>
      <add><![CDATA[
		  'store'      => $result['store_id'],
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $this->data['column_status'] = $this->language->get('column_status');
		  ]]></search>
      <add><![CDATA[
		  $this->data['column_store'] = $this->language->get('column_store');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if ($order == 'ASC') {
		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['filter_store'])) {
			$url .= '&filter_store=' . $this->request->get['filter_store'];
		}
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if (isset($this->request->get['order'])) {
		  ]]></search>
      <add><![CDATA[
		  if (isset($this->request->get['store'])) {
			$url .= '&store=' . $this->request->get['store'];
		}
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $this->data['sort_order'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.sort_order' . $url, 'SSL');
		  ]]></search>
      <add><![CDATA[
		  $this->data['sort_store'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.sort_store' . $url, 'SSL');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $this->data['filter_status'] = $filter_status;
		  ]]></search>
      <add><![CDATA[
		  $this->data['filter_store'] = $filter_store;
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  $this->data['entry_description'] = $this->language->get('entry_description');
		  ]]></search>
      <add><![CDATA[
		 $this->data['entry_store'] = $this->language->get('entry_store');
		  ]]></add>
    </operation>
  </file>
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  if (isset($this->request->post['keyword'])) {
		  ]]></search>
      <add><![CDATA[
		 $this->load->model('setting/store');
		 $this->data['stores'] = $this->model_setting_store->getStores();

		 if (isset($this->request->post['product_store'])) {
			$this->data['product_store'] = $this->request->post['product_store'];
		} elseif (isset($this->request->get['product_id'])) {
			$this->data['product_store'] = $this->model_catalog_product->getProductStores($this->request->get['product_id']);
		} else {
			$this->data['product_store'] = array(0);
		}	
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/controller/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  $this->template = 'catalog/product_list.tpl';
		  ]]></search>
      <add><![CDATA[
		 $this->load->model('setting/store');
		 $this->data['stores'] = $this->model_setting_store->getStores();

		  ]]></add>
    </operation>
  </file>
  <file name="admin/model/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  				$sql = "SELECT COUNT(DISTINCT p.product_id) AS total FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
		  ]]></search>
      <add><![CDATA[
		
			$sql .= " LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)";			
		
		  ]]></add>
    </operation>
  </file>
  <file name="admin/model/catalog/product.php">        
    <operation>
      <search position="after"><![CDATA[
		  		$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
		  ]]></search>
      <add><![CDATA[
		
			$sql .= " LEFT JOIN " . DB_PREFIX . "product_to_store p2s ON (p.product_id = p2s.product_id)";			
		
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/model/catalog/product.php">        
    <operation>
      <search position="before"><![CDATA[
		  		if (isset($data['filter_status']) && !is_null($data['filter_status'])) {
		  ]]></search>
      <add><![CDATA[
		if (isset($data['filter_store'])) {
			
				$sql .= " AND p2s.store_id = '".$data['filter_store']."'";
				
		}
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="before"><![CDATA[
		  <td class="right"><?php echo $column_action; ?></td>
		  ]]></search>
      <add><![CDATA[
		 <td class="left"><?php if ($sort == 'p.store') { ?>
                <a href="<?php echo $sort_store; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_store; ?></a>
                <?php } else { ?>
                <a href="<?php echo $sort_store; ?>"><?php echo $column_store; ?></a>
                <?php } ?></td>
		  ]]></add>
    </operation>
  </file>
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="before"><![CDATA[
		 <td align="right"><a onclick="filter();" class="button"><?php echo $button_filter; ?></a></td>
		  ]]></search>
      <add><![CDATA[
		<td><select name="filter_store">
                  <option value="*">*</option>
                  <?php 
                
					  foreach ($stores as $store) {
						  if ($filter_store && $filter_store == $store['store_id']) { 
						  ?>
						  <option value="<?php echo $store['store_id']; ?>" selected="selected"><?php echo $store['name']; ?></option>
					<?php
					  }else{
					  ?>
					  <option value="<?php echo $store['store_id']; ?>"><?php echo $store['name']; ?></option>
                  <?php }
						} ?>
                </select></td>
		  ]]></add>
    </operation>
  </file>
  
    <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="after"><![CDATA[
                  <td class="left"><?php echo $product['status']; ?></td>

		  ]]></search>
      <add><![CDATA[
		<td class=left"><?php 
  foreach ($stores as $store) {
	 if ((int)$product['store'] == (int)$store['store_id']) { 
          echo $store['name'];
          }
          }
	?>
 </td>
		  ]]></add>
    </operation>
  </file>
  
  <file name="admin/view/template/catalog/product_list.tpl">        
    <operation>
      <search position="after"><![CDATA[
		 var filter_status = $('select[name=\'filter_status\']').attr('value');
		  ]]></search>
      <add><![CDATA[
		var filter_store = $('select[name=\'filter_store\']').attr('value');
	
	if (filter_store != '*') {
		url += '&filter_store=' + encodeURIComponent(filter_store);
	}	
		  ]]></add>
    </operation>
  </file>


</modification>
